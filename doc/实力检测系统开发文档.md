# 视力监测分析系统｜开发文档（RuoYi-Cloud 版 · 课程作业极简可交付）

## 0. 概述

目标：支持医院或体检机构的年度视力监测、统计分析与年度报告导出。

范围：后台管理系统（B 端）；无个人用户门户；最小可交付（MVP）。

框架：RuoYi-Cloud 微服务（网关/认证/系统/监控等复用）。

自研服务：vision-service（唯一业务服务，聚合"人员/监测/统计/报告"）。

## 1. 功能模块与菜单

### 1.1 菜单树（后端管理）

视力监测分析系统
├─ 人员管理
│   └─ 人员列表（新增/编辑/删除/导入/导出/搜索）
├─ 年度视力监测
│   ├─ 录入监测数据（选择人员+年度+左右眼）
│   └─ 监测记录查询（编辑/删除/导入/导出/搜索）
├─ 统计与分析
│   ├─ 年度视力统计（人数/平均/正常率/近视率）
│   └─ 多年趋势与占比（折线/柱状/饼图）
└─ 报告管理
    └─ 年度报告（生成全院年度报告，导出 Excel/PDF）

### 1.2 权限标识（前后端一致）

人员：vision:person:list/add/edit/remove/import/export

记录：vision:record:list/add/edit/remove/import/export/template

统计：vision:stat:view

报告：vision:report:annual/export

若依按钮级权限在前端 v-hasPermi="['vision:person:add']" 等生效。

## 2. 数据库设计（MySQL 8）

字符集：utf8mb4；引擎：InnoDB；时区建议统一 +08:00。
极简两表即可（报告文件可直接按需导出，不强制缓存表）。

### 2.1 人员表 person

```sql
CREATE TABLE person (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '人员ID',
  name         VARCHAR(50) NOT NULL COMMENT '姓名',
  gender       CHAR(1) NOT NULL COMMENT '性别 M/F',
  birth_date   DATE NULL COMMENT '出生日期',
  phone        VARCHAR(20) NULL COMMENT '联系方式',
  id_card      VARCHAR(18) UNIQUE COMMENT '身份证号（唯一）',
  check_code   VARCHAR(50) NULL COMMENT '体检编号（院内编号）',
  create_time  DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time  DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_name(name),
  INDEX idx_check_code(check_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='人员信息表';
```

### 2.2 视力监测表 vision_record

```sql
CREATE TABLE vision_record (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '记录ID',
  person_id    BIGINT NOT NULL COMMENT '人员ID',
  check_date   DATE NOT NULL COMMENT '检测日期',
  year         INT NOT NULL COMMENT '年度（方便汇总）',
  left_eye     DECIMAL(3,1) NOT NULL COMMENT '左眼视力(小数制0.1-2.0建议)',
  right_eye    DECIMAL(3,1) NOT NULL COMMENT '右眼视力',
  diagnosis    VARCHAR(100) NULL COMMENT '诊断（正常/近视/散光/其他）',
  remark       VARCHAR(200) NULL COMMENT '备注',
  create_time  DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_time  DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  CONSTRAINT fk_record_person FOREIGN KEY (person_id) REFERENCES person(id) ON DELETE CASCADE,
  UNIQUE KEY uk_person_year (person_id, year),
  INDEX idx_year(year),
  INDEX idx_check_date(check_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='视力监测记录表';
```

### 2.3 视力等级规则（内置字典或常量）

计量制：小数制（0.1–2.0）

划分：

- 正常：≥ 1.0
- 轻度：0.8–<1.0
- 中度：0.6–<0.8
- 重度：< 0.6

后端以常量实现或挂靠若依字典 sys_dict_type = VISION_LEVEL。

## 3. 微服务与目录结构

### 3.1 服务拓扑

- ruoyi-gateway   （沿用）
- ruoyi-auth      （沿用）
- ruoyi-system    （沿用：用户/角色/菜单/日志）
- vision-service  （★ 新增：业务接口）
- ruoyi-ui        （前端：新增路由页面）

### 3.2 vision-service 目录建议

```
vision-service
├─ src/main/java/com/ruoyi/vision
│  ├─ VisionApplication.java
│  ├─ controller
│  │  ├─ PersonController.java
│  │  └─ VisionRecordController.java
│  ├─ domain
│  │  ├─ Person.java
│  │  └─ VisionRecord.java
│  ├─ dto
│  │  ├─ PersonQueryDTO.java
│  │  ├─ VisionRecordDTO.java
│  │  └─ StatQueryDTO.java
│  ├─ vo
│  │  ├─ PersonVO.java
│  │  ├─ VisionRecordVO.java
│  │  └─ StatVO.java
│  ├─ mapper
│  │  ├─ PersonMapper.java
│  │  └─ VisionRecordMapper.java
│  ├─ service
│  │  ├─ PersonService.java
│  │  ├─ VisionRecordService.java
│  │  └─ StatService.java
│  ├─ service/impl
│  ├─ util (Excel、PDF 工具按需)
│  └─ config (MyBatisPlus、Swagger 等)
└─ src/main/resources
   ├─ mapper/*.xml
   └─ application.yml
```

## 4. API 设计（REST）

### 4.1 人员管理

- GET /vision/person/list
  - 入参：name? idCard? pageNum pageSize
  - 出参：分页列表 PersonVO[]

- POST /vision/person（add）
  - 体：{name, gender, birthDate?, phone?, idCard?, checkCode?}

- PUT /vision/person（edit）
  - 体：同上 + id

- DELETE /vision/person/{id}

- POST /vision/person/import（Excel 导入，表头见 §7）

- GET /vision/person/export（Excel 导出）

### 4.2 年度视力监测

- GET /vision/record/list
  - 入参：name? idCard? year? pageNum pageSize

- POST /vision/record
  - 体：{personId, checkDate, year, leftEye, rightEye, diagnosis?, remark?}

- PUT /vision/record（同上 + id）

- DELETE /vision/record/{id}

- POST /vision/record/import（Excel 导入）

- GET /vision/record/export（Excel 导出）

- GET /vision/record/template（下载 Excel 模板）

### 4.3 统计与分析

- GET /vision/stat/annual?year=2025
  - 返回：
  ```json
  {
    "year": 2025,
    "total": 1200,
    "avgLeft": 1.02,
    "avgRight": 1.00,
    "normalRate": 0.56,
    "mildRate": 0.22,
    "moderateRate": 0.14,
    "highRate": 0.08
  }
  ```

- GET /vision/stat/trend?startYear=2022&endYear=2025
  - 返回：[{year, avgLeft, avgRight, normalRate, myopiaRate}]

### 4.4 年度报告

- GET /vision/report/annual/export?year=2025&format=excel|pdf
  - 返回：{fileUrl}

错误码统一沿用若依：R.fail("message")；必要时扩展：40001 参数错误 / 40002 数据重复 / 40401 未找到 / 500xx 服务异常。

## 5. 页面与交互（前端）

### 5.1 人员列表

表格列：姓名 | 性别 | 出生日期 | 身份证号 | 体检编号 | 手机 | 创建时间

操作：新增/编辑/删除/导入/导出

查询：姓名/身份证号

### 5.2 监测记录

表格列：姓名 | 年度 | 左眼 | 右眼 | 诊断 | 检测日期 | 备注 | 创建时间

操作：新增/编辑/删除/导入/导出/模板下载

查询：姓名/身份证号/年度

### 5.3 统计与分析（ECharts）

年度视力统计卡片：样本数/平均视力（L/R）/正常率/近视率

折线图：X=年份；Y1=avgLeft；Y2=avgRight

饼图或柱状图：某年等级占比（normal/mild/moderate/high）

### 5.4 年度报告

选择年份 → 生成数据 → 按钮导出（Excel/PDF）

## 6. 权限与菜单初始化 SQL（示例）

你可把 parent_id 挂到系统已有"业务管理"目录下；path/component 前端按项目实际改。

```sql
-- 顶级目录：视力监测分析系统
INSERT INTO sys_menu (menu_name, parent_id, order_num, path, component, is_frame, is_cache, menu_type, visible, status, perms, icon, create_by, create_time)
VALUES ('视力监测分析系统', 0, 1, 'vision', NULL, 1, 0, 'M', '0', '0', NULL, 'eye', 'admin', NOW());

SET @VISION_ID = LAST_INSERT_ID();

-- 人员管理
INSERT INTO sys_menu (menu_name, parent_id, order_num, path, component, menu_type, visible, status, perms, icon, create_by, create_time)
VALUES ('人员管理', @VISION_ID, 1, 'person', 'vision/person/index', 'C', '0', '0', 'vision:person:list', 'user', 'admin', NOW());
SET @PERSON_ID = LAST_INSERT_ID();

INSERT INTO sys_menu (menu_name, parent_id, order_num, menu_type, perms, create_time)
VALUES
('新增人员', @PERSON_ID, 1, 'F', 'vision:person:add', NOW()),
('编辑人员', @PERSON_ID, 2, 'F', 'vision:person:edit', NOW()),
('删除人员', @PERSON_ID, 3, 'F', 'vision:person:remove', NOW()),
('导入人员', @PERSON_ID, 4, 'F', 'vision:person:import', NOW()),
('导出人员', @PERSON_ID, 5, 'F', 'vision:person:export', NOW());

-- 年度视力监测
INSERT INTO sys_menu (menu_name, parent_id, order_num, path, component, menu_type, perms, icon, create_time)
VALUES ('年度视力监测', @VISION_ID, 2, 'record', 'vision/record/index', 'C', 'vision:record:list', 'form', NOW());
SET @RECORD_ID = LAST_INSERT_ID();

INSERT INTO sys_menu (menu_name, parent_id, order_num, menu_type, perms, create_time)
VALUES
('新增记录', @RECORD_ID, 1, 'F', 'vision:record:add', NOW()),
('编辑记录', @RECORD_ID, 2, 'F', 'vision:record:edit', NOW()),
('删除记录', @RECORD_ID, 3, 'F', 'vision:record:remove', NOW()),
('导入记录', @RECORD_ID, 4, 'F', 'vision:record:import', NOW()),
('导出记录', @RECORD_ID, 5, 'F', 'vision:record:export', NOW()),
('模板下载', @RECORD_ID, 6, 'F', 'vision:record:template', NOW());

-- 统计与分析
INSERT INTO sys_menu (menu_name, parent_id, order_num, path, component, menu_type, perms, icon, create_time)
VALUES ('统计与分析', @VISION_ID, 3, 'stat', 'vision/stat/index', 'C', 'vision:stat:view', 'chart', NOW());

-- 报告管理
INSERT INTO sys_menu (menu_name, parent_id, order_num, path, component, menu_type, perms, icon, create_time)
VALUES ('年度报告', @VISION_ID, 4, 'report', 'vision/report/index', 'C', 'vision:report:annual', 'documentation', NOW());
INSERT INTO sys_menu (menu_name, parent_id, order_num, menu_type, perms, create_time)
VALUES ('导出报告', LAST_INSERT_ID(), 1, 'F', 'vision:report:annual:export', NOW());
```

## 7. Excel 导入模板（建议）

人员导入（sheet 名：person）

- 姓名（必填）
- 性别（M/F，必填）
- 出生日期（yyyy-MM-dd，可空）
- 身份证号（可空；若填则唯一）
- 体检编号（可空）
- 手机（可空）

记录导入（sheet 名：vision_record）

- 身份证号 或 体检编号（至少一个，用于匹配人员）
- 年度（必填，int）
- 检测日期（必填，yyyy-MM-dd）
- 左眼视力（必填，0.1–2.0）
- 右眼视力（必填，0.1–2.0）
- 诊断（可空）
- 备注（可空）

导入时：若找不到人员，记录为"失败行"并返回失败原因；不自动创建人员（避免脏数据）。

## 8. 业务校验与计算规则

人员新增：name、gender 必填；id_card 若填写必须唯一且通过基本格式校验（18 位合法性可简化）。

记录新增：

- year 必须 == year(check_date)（不等则拒绝，或后端自动覆盖为 check_date 的年份）。
- left_eye、right_eye ∈ [0.1, 2.0] 且步进 0.1（前端限制 + 后端校验）。
- 唯一键 person_id + year（同一人同一年只允许一条记录）。

统计计算：

- 平均值：排除空值，保留 2 位小数。
- 等级率：以两眼 较低值 判定其等级并参与分布计算（可在代码注释清楚）。

导出：

- Excel 使用 EasyExcel；PDF 可选（时间不够只做 Excel）。

## 9. 开发与交付清单（课程验收可见）

- [ ] 两张表 SQL 初始化脚本
- [ ] 后端 vision-service（Controller/Service/Mapper/XML）
- [ ] 前端三页：人员 / 记录 / 统计；一页：年度报告
- [ ] Excel 导入/导出（人员、记录；模板下载）
- [ ] 统计接口 + ECharts 两图（折线 + 饼/柱）
- [ ] 菜单与权限初始化 SQL
- [ ] README：启动、账号、测试步骤
- [ ] 演示视频：3~5 分钟（增删改查→导入→统计→导出）

## 10. 提交规范

Git 提交规范（示例）：

```
feat(vision-person): add person import/export

fix(vision-record): validate year equals checkDate.year

docs: add develop doc and cursor rules
```

包名统一 com.ruoyi.vision.*

表名小写下划线，字段小写下划线；DTO/VO 驼峰。
